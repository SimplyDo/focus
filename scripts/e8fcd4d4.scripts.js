"use strict";angular.module("gtdApp",["ngRoute","ngTouch","ngAnimate","firebase","gtdApp.services","ui.sortable"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/tasks.html",controller:"tasksCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"loginCtrl"}).otherwise({redirectTo:"/"})}]);var servicesModule=angular.module("gtdApp.services",[]);angular.module("gtdApp").controller("tasksCtrl",["$scope","$filter","Data","$timeout","$routeParams","$location",function(a,b,c,d,e,f){a.lists=[],a.tasks=[],a.showListNavigation=!1,a.currentMode="today",a.unsavedData=!1;var g;a.firebase=!0,a.chromeapp=!1,a.firebase&&(c.authenticate(a,"user"),a.$on("angularFireAuth:login",function(b,d){c.setListToScope(a,"lists","userdata/"+d.id+"/lists")}),a.$on("angularFireAuth:logout",function(){f.path("/login")}),a.logout=function(){c.logout()}),a.chromeapp&&(chrome.storage.local.get("lists",function(b){a.lists=b.lists,console.log("data loaded")}),chrome.storage.onChanged.addListener(function(a){a.lists}),a.$on("updated",function(b,c){if(!c)var c="something was updated";d.cancel(g),a.unsavedData=!0,console.log(c),g=d(function(){a.unsavedData=!1,chrome.storage.local.set({lists:a.lists},function(){console.log("data saved")})},500)}));var h=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},i=function(){return h()+h()+"-"+h()+"-"+h()+"-"+h()+"-"+h()+h()+h()},j=function(a){for(var b={},c=[],d=0,e=a.length;e>d;++d)b.hasOwnProperty(a[d])||(c.push(a[d]),b[a[d]]=1);return c};a.toggleListNavigation=function(b){return a.showListNavigation="hide"==b?!1:!a.showListNavigation,a.showListNavigation},a.getTags=function(b){if(b&&b.tasks)var c=a.getListByID(b.id).tasks;else if(!b)for(var c=[],d=0;d<a.lists.length;d++)c=c.concat(a.lists[d].tasks);var e=[];if(c&&c.length>0){for(var f=0;f<c.length;f++)if(null!=c[f]){var g=c[f];if(0==g.done){var h=a.tags(g);e=e.concat(h)}}return j(e)}},a.countTasks=function(b,c){var d={};d.open=0,d.done=0,d.all=0,d.due=0,d.starred=0;for(var e=0;e<c.length;e++)if(null!=c[e]){var f=c[e];0==f.done&&a.relativeDueDate(f.dueDate)<=b+1&&d.due++,0==f.done&&1==f.starred&&d.starred++,0==f.done?d.open++:1==f.done&&d.done++}return d.all=d.open+d.done,d.today=d.due+d.starred,d},a.allTasks=function(b){for(var c=[],d=0;d<a.lists.length;d++)c=c.concat(a.lists[d].tasks);if(b){for(var e=[],d=0;d<c.length;d++)null!=c[d]&&a.relativeDueDate(c[d].dueDate)<=b&&e.push(c[d]);return e}return c},a.todaysTasks=function(){for(var b=[],c=0;c<a.lists.length;c++)a.lists[c].tasks&&a.lists[c].tasks.length>0&&b.push(a.lists[c].tasks[0]);return b},a.setDueDate=function(c,d){if(d||0==d){var e=new Date;e.setDate(e.getDate()+d),c.dueDate=b("date")(e,"MM/dd/yyyy")}else c.dueDate=null;a.$broadcast("updated","changed due date")},a.relativeDueDate=function(a){if(a){var b=864e5,c=new Date,d=new Date(a),e=Math.ceil((d.getTime()-c.getTime())/b);return 0>e?0:e+1}},a.getListByID=function(b){if(b){for(var c=0;c<a.lists.length;c++)if(a.lists[c].id==b)return a.lists[c];return"No matching list found"}},a.getTask=function(b){for(var c=a.getListByID(b.list),d=0;d<c.tasks.length;d++){var e=c.tasks[d];if(null!=e&&e.UUID==b.UUID)return e}},a.updateListName=function(b,c){var d=a.getListByID(b.id);return d.label=c,a.$broadcast("updated","updated list name"),d},a.switchMode=function(b){a.currentMode=b,a.changeTagFilter(),a.showListNavigation=!1},a.showTask=function(b){b?(a.currentTask={},a.currentTask.UUID=b.UUID,a.currentTask.list=b.list,a.currentTask.text=b.text,a.currentTask.dueDate=b.dueDate,a.currentTask.description=b.description):a.currentTask=!1},a.moveTaskToList=function(b,c){var d=a.deleteTask(b)[0],e=a.getListByID(c);k(e,d)},a.selectList=function(b){a.currentList=b?b:a.lists[0],a.newName=a.currentList.label,a.switchMode("list"),a.showListNavigation=!1,a.manageList=!1},a.tags=function(a){var b=[];return a&&(a.text.replace(/[#]+[A-Za-z0-9-_]+/g,function(a){var c=a.replace("#","");return b.push(c),"#"+c}),a.tagList!=b&&(a.tagList=b)),b},a.stripHashTags=function(a){return a?a=a.replace(/[#]+[A-Za-z0-9-_]+/g,function(a){return a.replace("#",""),""}):void 0},a.createTask=function(b,c,d){if(b){var e={},f=a.getListByID(c.id);e.text=b,e.done=!1,e.starred=!1,e.created=new Date,k(f,e),1==d&&a.showTask(e)}};var k=function(b,c){return c.list=b.id,c.UUID=i(),b.tasks&&0!=b.tasks.length?b.tasks.splice(0,0,c):b.tasks=[c],a.$broadcast("updated","task added to list"),c};a.createList=function(b){b||(b="New task list");var c={id:i(),label:b};a.lists.splice(0,0,c),a.$broadcast("updated","list created"),a.selectList(c),a.switchMode("list")},a.changeTagFilter=function(b){return b&&a.tagFilter==b?(a.tagFilter=void 0,void 0):(a.tagFilter=b,void 0)},a.deleteTask=function(b){for(var c=a.getListByID(b.list).tasks,d=0;d<c.length;d++)if(null!=c[d]&&c[d].UUID==b.UUID)return a.$broadcast("updated","task deleted"),c.splice(d,1)},a.updateTask=function(b){var c=a.getTask(b);c.text=b.text,c.dueDate=b.dueDate,c.description=b.description,a.$broadcast("updated","task updated")},a.toggleStar=function(b){b.starred=!b.starred,a.$broadcast("updated","task star toggled")},a.toggleDone=function(b){b.done=!b.done,b.done&&(b.doneDate=new Date),a.$broadcast("updated","task done toggled")},a.deleteAll=function(b,c){if(c&&a.lists.length>1){for(var d=0;d<a.lists.length;d++)if(a.lists[d].id==b){a.lists.splice(d,1),a.switchMode("today");break}a.$broadcast("updated","list deleted")}else a.getListByID(b).tasks=[],a.$broadcast("updated","all tasks in list deleted")},a.returnString=function(a,b){return a[b]},a.exportData=function(){a.jsonData=angular.toJson(a.lists,!0)},a.importData=function(b){b&&(a.lists=angular.fromJson(b),a.$broadcast("updated","data dump imported"))},a.sortableOptionsTasks={update:function(){a.$broadcast("updated","tasks re-ordered")},axis:"y",handle:".tasks-list-item-handle"},a.sortableOptionsLists={update:function(){a.$broadcast("updated","lists re-ordered")},axis:"y",handle:".list-nav-item-handle"},a.switchMode("today")}]),angular.module("gtdApp").controller("loginCtrl",["Data","$scope","$location",function(a,b,c){b.firebase=!0,b.firebase||c.path("/"),a.authenticate(b,"user"),b.submitted=!1,b.signUp=function(c){b.errorMessage="",b.submitted=!0,c.password==c.passwordConfirm?a.signUp(c.email,c.password):b.errorMessage="Passwords do not match"},b.login=function(c){b.errorMessage="",b.submitted=!0,a.login(c.email,c.password,c.rememberMe)},b.logout=function(){a.logout(),b.submitted=!1},b.$on("angularFireAuth:login",function(){c.path("/")}),b.$on("angularFireAuth:logout",function(){}),b.$on("angularFireAuth:error",function(a,c){b.submitted=!1,c&&"INVALID_USER"==c.code?b.errorMessage="Wrong Email":c&&"INVALID_PASSWORD"==c.code&&(b.errorMessage="Wrong password")})}]),servicesModule.factory("Data",["angularFire","angularFireAuth",function(a,b){var c="https://simplydogtd.firebaseio.com/",d=new Firebase(c);return{setListToScope:function(b,c,e){e?a(d.child(e),b,c):a(d,b,c)},authenticate:function(a,c){b.initialize(d,{scope:a,name:c,callback:function(){}})},logout:function(){b.logout()},login:function(a,c,d){b.login("password",{email:a,password:c,rememberMe:d})},signUp:function(a,c){b.createUser(a,c,function(){})}}}]);