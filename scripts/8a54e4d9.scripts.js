"use strict";angular.module("gtdApp",["ngRoute","ngTouch","gtdApp.services","firebase","ui.sortable"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/tasks.html",controller:"tasksCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"loginCtrl"}).otherwise({redirectTo:"/"})}]);var servicesModule=angular.module("gtdApp.services",[]);angular.module("gtdApp").controller("tasksCtrl",["$scope","$filter","Data","$routeParams","$location","angularFire","angularFireAuth",function(a,b,c,d,e,f,g){a.lists=[],a.tasks=[],a.showNavigation=!0;var h=new Firebase("https://simplydogtd.firebaseio.com/");g.initialize(h,{scope:a,name:"user",callback:function(){}}),a.logout=function(){g.logout()},a.$on("angularFireAuth:login",function(b,c){f(h.child("userdata/"+c.id+"/lists"),a,"lists").then(function(){0==a.lists.length&&a.lists.push({id:j(),label:"My first task list"});for(var b=0;b<a.lists.length;b++);a.showList()})}),a.$on("angularFireAuth:logout",function(){e.path("/login")});var i=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},j=function(){return i()+i()+"-"+i()+"-"+i()+"-"+i()+"-"+i()+i()+i()},k=function(a){for(var b={},c=[],d=0,e=a.length;e>d;++d)b.hasOwnProperty(a[d])||(c.push(a[d]),b[a[d]]=1);return c};a.getTags=function(b){if(b&&b.tasks){var c=[],d=a.getListByID(b.id).tasks;if(d&&d.length>0){for(var e=0;e<d.length;e++)if(null!=d[e]){var f=d[e];if(0==f.done){var g=a.tags(f);c=c.concat(g)}}return k(c)}}},a.countTasks=function(b,c){var d={};d.open=0,d.done=0,d.all=0,d.due=0,d.starred=0;for(var e=0;e<c.length;e++)if(null!=c[e]){var f=c[e];0==f.done&&a.relativeDueDate(f.dueDate)<=b+1&&d.due++,0==f.done&&1==f.starred&&d.starred++,0==f.done?d.open++:1==f.done&&d.done++}return d.all=d.open+d.done,d.today=d.due+d.starred,d},a.allTasks=function(b){for(var c=[],d=0;d<a.lists.length;d++)c=c.concat(a.lists[d].tasks);if(b){for(var e=[],d=0;d<c.length;d++)a.relativeDueDate(c[d].dueDate)<=b&&e.push(c[d]);return e}return c},a.setDueDate=function(c,d){var e=a.getTask(c);if(d||0==d){var f=new Date;f.setDate(f.getDate()+d),e.dueDate=b("date")(f,"MM/dd/yyyy")}else e.dueDate=null},a.relativeDueDate=function(a){if(a){var b=864e5,c=new Date,d=new Date(a),e=Math.ceil((d.getTime()-c.getTime())/b);return 0>e?0:e+1}},a.getListByID=function(b){if(b){for(var c=0;c<a.lists.length;c++)if(a.lists[c].id==b)return a.lists[c];return"No matching list found"}},a.getTask=function(b){for(var c=a.getListByID(b.list),d=0;d<c.tasks.length;d++){var e=c.tasks[d];if(null!=e&&e.UUID==b.UUID)return e}},a.showTask=function(b){b?(a.currentTask=b,a.searchTerm=""):a.currentTask=!1},a.showToday=function(b){b?(a.today=!0,a.showTask(!1),a.changeTagFilter(),a.showNavigation=!1):a.today=!1},a.moveTaskToList=function(b,c){var d=a.deleteTask(b)[0],e=a.getListByID(c),f=l(e,d);a.currentTask&&a.showTask(f)},a.showList=function(b){a.showTask(!1),a.showToday(!1),a.searchTerm="",a.changeTagFilter(),a.currentList=b?b:a.lists[0],a.showNavigation=!1},a.tags=function(a){var b=[];return a&&(a.text.replace(/[#]+[A-Za-z0-9-_]+/g,function(a){var c=a.replace("#","");return b.push(c),"#"+c}),a.tagList!=b&&(a.tagList=b)),b},a.stripHashTags=function(a){return a?a=a.replace(/[#]+[A-Za-z0-9-_]+/g,function(a){return a.replace("#",""),""}):void 0},a.createTask=function(b,c,d){var e={},f=a.getListByID(c.id);e.text=b,e.done=!1,e.starred=!1,e.created=new Date,l(f,e),1==d&&a.showTask(e)};var l=function(a,b){return b.list=a.id,b.UUID=j(),a.tasks&&0!=a.tasks.length?a.tasks.splice(0,0,b):a.tasks=[b],b};a.createList=function(b){b||(b="New task list"),a.lists.push({id:j(),label:b})},a.changeTagFilter=function(b){a.tagFilter=b},a.deleteTask=function(b){for(var c=a.getListByID(b.list).tasks,d=0;d<c.length;d++)if(null!=c[d]&&c[d].UUID==b.UUID)return c.splice(d,1)},a.toggleStar=function(a){a.starred=!a.starred},a.toggleDone=function(a){a.done=!a.done,a.done&&(a.doneDate=new Date)},a.deleteAll=function(b,c){if(c&&a.lists.length>1){for(var d=0;d<a.lists.length;d++)if(a.lists[d].id==b){a.lists.splice(d,1);break}a.showList()}else a.getListByID(b).tasks=[]},a.sortableOptionsTasks={update:function(b,c){(a.tagFilter||a.omniBox)&&(c.item.parent().sortable("cancel"),alert("Sorting is not available when list is fitlered"))},axis:"y",handle:".task-list-item-options-sortable"},a.sortableOptionsLists={axis:"y",handle:".list-nav-item-handle"}}]),angular.module("gtdApp").controller("loginCtrl",["$scope","$location","angularFire","angularFireAuth",function(a,b,c,d){var e=new Firebase("https://simplydogtd.firebaseio.com/");d.initialize(e,{scope:a,name:"user",callback:function(){}}),a.submitted=!1,a.signUp=function(b){a.errorMessage="",a.submitted=!0,b.password==b.passwordConfirm?d.createUser(b.email,b.password,function(a,b){a||console.log("User Id: "+b.id+", Email: "+b.email)}):a.errorMessage="Passwords do not match"},a.changePassword=function(b){a.errorMessage="",alert("changing pass"),d.changePassword(b.email,b.password,b.passwordConfirm,function(a){a?alert(a):console.log("Password change successfully")})},a.login=function(b){a.errorMessage="",a.submitted=!0,d.login("password",{email:b.email,password:b.password,rememberMe:b.rememberMe})},a.logout=function(){d.logout(),a.submitted=!1},a.$on("angularFireAuth:login",function(){b.path("/")}),a.$on("angularFireAuth:logout",function(){}),a.$on("angularFireAuth:error",function(b,c){a.submitted=!1,c&&"INVALID_USER"==c.code?a.errorMessage="Wrong Email":c&&"INVALID_PASSWORD"==c.code&&(a.errorMessage="Wrong password")})}]),servicesModule.factory("Data",[function(){return this.tasks=[],this.lists=[],this.systemLists=[],this}]);